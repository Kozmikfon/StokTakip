@model StokTakip.Entities.ViewModels.IrsaliyePageVm
@using StokTakip.Entities.Dtos.IrsaliyeDtos
@using StokTakip.Entities.Enums

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isOnayli = Model.IsOnayli;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>

<div class="container py-3">
    <h3>
        İrsaliye Düzenle
        <span class="badge @(isOnayli ? "bg-success" : "bg-secondary")">
            @(isOnayli ? "Onaylı" : "Taslak")
        </span>
    </h3>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <form asp-action="Save" asp-controller="Irsaliye" method="post" class="card p-3 mb-4">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PostModel.Id" />

        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">İrsaliye No</label>
                <input class="form-control" asp-for="PostModel.IrsaliyeNo" readonly="@isOnayli" />
                <span class="text-danger" asp-validation-for="PostModel.IrsaliyeNo"></span>
            </div>

            <div class="col-md-3">
                <label class="form-label">Cari</label>
                <select class="form-select" asp-for="PostModel.CarId" asp-items="Model.Cariler" disabled="@isOnayli"></select>
                <span class="text-danger" asp-validation-for="PostModel.CarId"></span>
            </div>

            <div class="col-md-3">
                <label class="form-label">Depo</label>
                <select class="form-select" asp-for="PostModel.DepoId" asp-items="Model.Depolar" disabled="@isOnayli"></select>
                <span class="text-danger" asp-validation-for="PostModel.DepoId"></span>
            </div>

            <div class="col-md-3">
                <label class="form-label">Tarih</label>
                <input type="datetime-local" class="form-control" asp-for="PostModel.IrsaliyeTarihi" readonly="@isOnayli" />
                <span class="text-danger" asp-validation-for="PostModel.IrsaliyeTarihi"></span>
            </div>

            <div class="col-md-3">
                <label class="form-label">İrsaliye Tipi</label>
                <select class="form-select" asp-for="PostModel.IrsaliyeTipi" disabled="@isOnayli">
                    <option value="@IrsaliyeTipi.Giris">Giriş</option>
                    <option value="@IrsaliyeTipi.Cikis">Çıkış</option>
                </select>
                <span class="text-danger" asp-validation-for="PostModel.IrsaliyeTipi"></span>
            </div>

            <div class="col-md-9">
                <label class="form-label">Açıklama</label>
                <input class="form-control" asp-for="PostModel.Aciklama" readonly="@isOnayli" />
                <span class="text-danger" asp-validation-for="PostModel.Aciklama"></span>
            </div>
        </div>


        @if (!isOnayli)
        {
            <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Kaydet (Taslak)</button>

                <form asp-action="TalepOlustur" asp-controller="Irsaliye" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.PostModel.Id" />
                    <button type="submit" class="btn btn-success">Talep Oluştur (Onayla)</button>
                </form>

                <form asp-action="Delete" asp-controller="Irsaliye" method="post" class="d-inline" onsubmit="return confirm('Silinsin mi?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.PostModel.Id" />
                    <button type="submit" class="btn btn-outline-danger">Sil</button>
                </form>
            </div>
        }
    </form>

    <!-- DETAY GRID -->
    <div class="card p-3">
        <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-3">Detaylar</h5>
            @if (!isOnayli)
            {
                <div class="d-flex gap-2">
                    <select id="ddlMalzeme" class="form-select" style="min-width:220px;">
                        @foreach (var item in Model.Malzemeler)
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                    <input id="txtMiktar" class="form-control" type="number" step="0.0001" min="0" placeholder="Miktar" />
                    <input id="txtBirimFiyat" class="form-control" type="number" step="0.01" min="0" placeholder="Birim Fiyat" />
                    <input id="txtSeriNo" class="form-control" type="text" placeholder="Seri No" />
                    <button id="btnAddLine" class="btn btn-secondary">Satır Ekle</button>
                </div>
            }
        </div>

        <table class="table table-sm table-striped align-middle" id="detayTable">
            <thead>
                <tr>
                    <th>Malzeme</th>
                    <th class="text-end">Miktar</th>
                    <th class="text-end">Birim Fiyat</th>
                    <th class="text-end">Ara Toplam</th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody id="detayBody">
            @foreach (var d in Model.Irsaliye.Detaylar)
            {
                <tr data-id="@d.Id" data-malzemeid="@d.malzemeId">
                    <td>@(d.malzemeAd ?? d.malzemeId.ToString())</td>
                    <td class="text-end">@d.miktar</td>
                    <td class="text-end">@d.birimFiyat</td>
                    <td class="text-end">@d.araToplam</td>
                    <td class="text-end">
                        @if (!isOnayli)
                        {
                            <button class="btn btn-sm btn-outline-danger btnRemove">Sil</button>
                        }
                    </td>
                </tr>
            }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-end">Genel Toplam</th>
                    <th class="text-end" id="genelToplam">@Model.Irsaliye.toplamTutar?.ToString("0.00")</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

@section Scripts{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <partial name="_ValidationScriptsPartial" />
    <script>
        function recalcTotal() {
            let toplam = 0;
            $("#detayBody tr").each(function() {
                const ara = parseFloat($(this).find("td").eq(3).text()) || 0;
                toplam += ara;
            });
            $("#genelToplam").text(toplam.toFixed(2));
        }

        // SATIR EKLE (Artık DetayController'a istek atıyoruz)
        $("#btnAddLine").on("click", function(e){
            e.preventDefault();
            const irsaliyeId = @Model.PostModel.Id;
            const malzemeId = parseInt($("#ddlMalzeme").val());
            const malzemeText = $("#ddlMalzeme option:selected").text();
            const miktar = parseFloat($("#txtMiktar").val());
            const birimFiyat = parseFloat($("#txtBirimFiyat").val());
            const seriNo = $("#txtSeriNo").val() || null;

            if(!malzemeId || !miktar || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat) || birimFiyat < 0){
                alert("Malzeme/Miktar/Birim Fiyat kontrol edin.");
                return;
            }

            const payload = {
                irsaliyeId: irsaliyeId,
                malzemeId: malzemeId,
                miktar: miktar,
                birimFiyat: birimFiyat,
                seriNo: seriNo
            };

            $.ajax({
                url: '@Url.Action("Add","Detay")', // ← DetayController
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(list){
                    const body = $("#detayBody").empty();
                    list.forEach(function(d){
                        body.append(`
                          <tr data-id="${d.id}" data-malzemeid="${d.malzemeId}">
                            <td>${d.malzemeAd ?? d.malzemeId}</td>
                            <td class="text-end">${d.miktar}</td>
                            <td class="text-end">${d.birimFiyat}</td>
                            <td class="text-end">${d.araToplam}</td>
                            <td class="text-end"><button class="btn btn-sm btn-outline-danger btnRemove">Sil</button></td>
                          </tr>`);
                    });
                    recalcTotal();
                    $("#txtMiktar").val(""); $("#txtBirimFiyat").val(""); $("#txtSeriNo").val("");
                },
                error: function(xhr){
                    alert(xhr.responseText || "Satır eklenemedi.");
                }
            });
        });

        // SATIR SİL
        $(document).on("click",".btnRemove", function(){
            const tr = $(this).closest("tr");
            const detayId = tr.data("id");
            const irsaliyeId = @Model.PostModel.Id;

            $.ajax({
                url: '@Url.Action("Remove","Detay")', // ← DetayController
                type: 'POST',
                data: { irsaliyeId: irsaliyeId, detayId: detayId },
                success: function(list){
                    const body = $("#detayBody").empty();
                    list.forEach(function(d){
                        body.append(`
                          <tr data-id="${d.id}" data-malzemeid="${d.malzemeId}">
                            <td>${d.malzemeAd ?? d.malzemeId}</td>
                            <td class="text-end">${d.miktar}</td>
                            <td class="text-end">${d.birimFiyat}</td>
                            <td class="text-end">${d.araToplam}</td>
                            <td class="text-end"><button class="btn btn-sm btn-outline-danger btnRemove">Sil</button></td>
                          </tr>`);
                    });
                    recalcTotal();
                },
                error: function(xhr){
                    alert(xhr.responseText || "Satır silinemedi.");
                }
            });
        });

        recalcTotal();
    </script>
}

